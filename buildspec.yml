version: 0.2

phases:
  install:
    commands:
      - echo "Installing dependencies..."
      - yum install -y rsync openssh-clients
      - composer install --no-interaction --prefer-dist --optimize-autoloader
      - echo "$SSH_PRIVATE_KEY" > /tmp/id_rsa
      - chmod 600 /tmp/id_rsa

  build:
    commands:
      - echo "Deploying to both EC2 instances via SSH..."
      - for HOST in 10.0.2.18 10.0.5.56; do
          echo "Deploying to $HOST";
          rsync -avz -e "ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no" ./ ec2-user@$HOST:/var/www/html/;
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ec2-user@$HOST "sudo systemctl restart nginx php-fpm";
        done
